Align
=====

We will produce two alignment versions, one using conventional block matching image pair alignment, and another using SEAMLeSS ConvNet based approach.
Both alignments will be performed at MIP7, the resulting alignment field will be saved at MIP7 resolution to ``{dst_folder}/field/field_aligned``. 

Block Matching
--------------

First, let's align the stack using conventional block matching image pair alignment method.
This is done by providing an alignment processor that implements block matching to the ``corgie align-block`` command:

.. include:: align_blockmatch.rst

The ``--processor_spec`` specifies an image pair alignment method, and ``--processor_mip`` specifies what resolution to apply it to. You can can change the ``tile_size``, ``tile_step``, ``max_disp`` and ``r_delta`` parameters and see how it affects your result. To avoid rewriting data from previous runs, use different ``--dst_folder`` and/or ``--suffix``. 

To learn more about the meaning of ``tile_size``, ``tile_step``, ``max_disp`` and ``r_delta`` parameters, please refer to `this link <https://imagej.net/Elastic_Alignment_and_Montage>`_.

Reference expected output can be visualized in the ``Blockmatch Aligned Cutout Normalized Image`` the following `Neuroglancer Link
<https://neuromancer-seung-import.appspot.com/#!%7B%22layers%22:%5B%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/example_stack/img/unaligned%22%2C%22crossSectionRenderScale%22:0.25%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Full%20Stack%20Image%22%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/example_stack/mask/fold_mask%22%2C%22crossSectionRenderScale%22:1.862645149230957e-9%2C%22type%22:%22segmentation%22%2C%22skeletonRendering%22:%7B%22mode2d%22:%22lines_and_points%22%2C%22mode3d%22:%22lines%22%7D%2C%22name%22:%22Unaligned%20Full%20Stack%20Fold%20Mask%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/img/unaligned%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Cutout%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/mask/fold_mask%22%2C%22type%22:%22segmentation%22%2C%22skeletonRendering%22:%7B%22mode2d%22:%22lines_and_points%22%2C%22mode3d%22:%22lines%22%7D%2C%22name%22:%22Unaligned%20Cutout%20Fold%20Mask%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/img/img_norm%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/aligned_blockmatch/img/img_aligned%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Blockmatch%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/aligned_seamless/img/img_aligned%22%2C%22crossSectionRenderScale%22:5.960464477539063e-8%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22SEAMLeSS%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%5D%2C%22navigation%22:%7B%22pose%22:%7B%22position%22:%7B%22voxelSize%22:%5B4%2C4%2C40%5D%2C%22voxelCoordinates%22:%5B198298.625%2C193354.828125%2C17000%5D%7D%7D%2C%22zoomFactor%22:528.604717707434%7D%2C%22selectedLayer%22:%7B%22layer%22:%22SEAMLeSS%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:true%7D%2C%22layout%22:%22xy%22%7D>`_. Alignment in the resulting stack is generally improved, but the discontinuous defects are not corrected. Note that the alignment quality can be improved by finding more optimal hyperparameters.

SEAMLeSS
--------
To correct discontinuous defects, let's retry the alignment, but this time using SEAMLeSS image pair alignment method:

.. include:: align_seamless.rst


.. note::

   The command specifies usage of GPU accelerator through ``--device cuda``. If your environment does not have cuda-enabled GPU,
   please use ``--device cpu`` instead.



Reference expected output can be visualized in the ``SEAMLeSS Aligned Cutout Normalized Image`` the following `Neuroglancer Link
<https://neuromancer-seung-import.appspot.com/#!%7B%22layers%22:%5B%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/example_stack/img/unaligned%22%2C%22crossSectionRenderScale%22:0.25%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Full%20Stack%20Image%22%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/example_stack/mask/fold_mask%22%2C%22crossSectionRenderScale%22:1.862645149230957e-9%2C%22type%22:%22segmentation%22%2C%22skeletonRendering%22:%7B%22mode2d%22:%22lines_and_points%22%2C%22mode3d%22:%22lines%22%7D%2C%22name%22:%22Unaligned%20Full%20Stack%20Fold%20Mask%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/img/unaligned%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Cutout%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/mask/fold_mask%22%2C%22type%22:%22segmentation%22%2C%22skeletonRendering%22:%7B%22mode2d%22:%22lines_and_points%22%2C%22mode3d%22:%22lines%22%7D%2C%22name%22:%22Unaligned%20Cutout%20Fold%20Mask%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/img/img_norm%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Unaligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/aligned_blockmatch/img/img_aligned%22%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22Blockmatch%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%2C%7B%22source%22:%22precomputed://gs://corgie_package/walkthrough/expected_output/aligned_seamless/img/img_aligned%22%2C%22crossSectionRenderScale%22:5.960464477539063e-8%2C%22type%22:%22image%22%2C%22blend%22:%22default%22%2C%22shader%22:%22void%20main%28%29%20%7B%5Cn%20%20emitGrayscale%280.5%20+%200.2%20%2A%20toNormalized%28getDataValue%28%29%29%29%3B%5Cn%7D%5Cn%22%2C%22shaderControls%22:%7B%7D%2C%22name%22:%22SEAMLeSS%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:false%7D%5D%2C%22navigation%22:%7B%22pose%22:%7B%22position%22:%7B%22voxelSize%22:%5B4%2C4%2C40%5D%2C%22voxelCoordinates%22:%5B198298.625%2C193354.828125%2C17000%5D%7D%7D%2C%22zoomFactor%22:528.604717707434%7D%2C%22selectedLayer%22:%7B%22layer%22:%22SEAMLeSS%20Aligned%20Cutout%20Normalized%20Image%22%2C%22visible%22:true%7D%2C%22layout%22:%22xy%22%7D>`_. The numerous discontinuous defects present in the stack are now corrected when viewed at MIP7 resolution.

To learn more about ``align-block`` command, please refer to :ref:`align-block command documentation <align-block command>`.

